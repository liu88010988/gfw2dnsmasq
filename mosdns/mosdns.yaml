# https://github.com/IrineSistiana/mosdns/discussions/605
# 域名和ip均来自：https://github.com/Loyalsoldier/v2ray-rules-dat
# hosts：自己定义的静态hosts
# china-ip-list.txt：https://raw.githubusercontent.com/Loyalsoldier/geoip/release/text/cn.txt
# direct-list.txt：https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/direct-list.txt
# apple-cn.txt：https://github.com/Loyalsoldier/v2ray-rules-dat/blob/release/apple-cn.txt
# proxy-list.txt：https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/proxy-list.txt

log:
  level: info
  file: "/etc/mosdns/mosdns.log"

plugins:
  # 转发至国内DNS，并发查询
  - tag: forward_local
    type: forward
    args:
      concurrent: 2
      upstreams:
        - addr: udp://119.29.29.29
        - addr: udp://223.5.5.5

  # 转发至国外DNS，并发查询
  - tag: forward_remote
    type: forward
    args:
      concurrent: 2
      upstreams:
        - addr: tcp://8.8.8.8
        - addr: tcp://1.1.1.1

  # 自定义hosts
  - tag: hosts
    type: hosts
    args:
      files:
        - "/etc/mosdns/hosts"

  # china ip
  - tag: china_ip
    type: ip_set
    args:
      files:
        - /etc/mosdns/china-ip-list.txt

  # fallback的primary服务器,返回非国内ip则drop_resp
  - tag: local_sequence
    type: sequence
    args:
      - exec: $forward_local
      - matches: "resp_ip $china_ip"
        exec: accept
      - exec: drop_resp

  # fallback的secondary服务器
  - tag: remote_sequence
    type: sequence
    args:
      - exec: $forward_remote
      - matches: has_resp
        exec: accept

  # fallback sequence
  - tag: fallback
    type: fallback
    args:
      primary: local_sequence
      secondary: remote_sequence
      threshold: 500
      always_standby: true

  # 主运行序列
  - tag: main_sequence
    type: sequence
    args:
      - exec: $hosts
      - matches: has_resp
        exec: accept

      - matches: qtype 65
        exec: reject 3

      - exec: prefer_ipv4

      - matches: qname &/etc/mosdns/direct-list.txt &/etc/mosdns/apple-cn.txt
        exec: $forward_local
      - matches: has_resp
        exec: accept

      - matches: qname &/etc/mosdns/proxy-list.txt
        exec: $forward_remote
      - matches: has_resp
        exec: accept

      - exec: $fallback

  # 启动监听服务
  - tag: udp_server
    type: udp_server
    args:
      entry: main_sequence
      listen: :53

  - tag: tcp_server
    type: tcp_server
    args:
      entry: main_sequence
      listen: :53
